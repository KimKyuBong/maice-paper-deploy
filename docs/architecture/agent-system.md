# MAICE 에이전트 시스템 아키텍처

## 📋 개요

MAICE 에이전트 시스템은 질문 분류, 명료화, 답변 생성, 학습 관찰의 4단계 프로세스를 자동화하는 분산 AI 에이전트 시스템입니다. Redis Streams와 Pub/Sub를 활용한 비동기 통신으로 높은 성능과 확장성을 제공합니다.

## 🤖 에이전트 구성

### 1. QuestionClassifierAgent (질문 분류 에이전트)

**역할**: 학생의 수학 질문을 분석하여 유형을 분류하고 후속 처리 방향을 결정

**주요 기능**:
- 질문을 K1(사실적), K2(개념적), K3(절차적), K4(메타인지적) 4가지 유형으로 분류
- answerable/needs_clarify/unanswerable 3단계 게이팅 판정
- 명료화가 필요한 경우 구체적인 명료화 질문 생성
- 수학 외 영역 질문 필터링

**통신 방식**:
- **입력**: Redis Streams (백엔드 → 에이전트)
- **출력**: Redis Streams (에이전트 → 백엔드) + Pub/Sub (에이전트 → 에이전트)

### 2. QuestionImprovementAgent (명료화 에이전트)

**역할**: 분류된 질문이 명료하지 않은 경우 추가 정보를 수집하여 질문을 개선

**주요 기능**:
- 분류 에이전트가 제안한 명료화 질문을 사용자에게 전달
- 사용자의 답변을 LLM으로 평가하여 충분한지 판단
- 질문 유형 재분류 (K1→K2, K2→K3 등)
- 명료화 완료 시 최종 질문 생성

**통신 방식**:
- **입력**: Redis Streams (백엔드 → 에이전트) + Pub/Sub (에이전트 → 에이전트)
- **출력**: Redis Streams (에이전트 → 백엔드) + Pub/Sub (에이전트 → 에이전트)

### 3. AnswerGeneratorAgent (답변 생성 에이전트)

**역할**: 분류되고 명료화된 질문에 대해 교육적이고 체계적인 답변을 생성

**주요 기능**:
- 질문 유형별 맞춤형 답변 생성 (K1-K4)
- 한국 고등학교 교육과정 수준에 맞는 답변
- LaTeX 수식 지원
- 실시간 스트리밍 답변 생성

**통신 방식**:
- **입력**: Pub/Sub (에이전트 → 에이전트)
- **출력**: Redis Streams (에이전트 → 백엔드) + Pub/Sub (에이전트 → 에이전트)

### 4. ObserverAgent (학습 관찰 에이전트)

**역할**: 전체 대화 과정을 관찰하고 분석하여 학습 요약을 생성

**주요 기능**:
- 질문, 명료화 과정, 답변을 종합 분석
- 학습 맥락 정보 추출
- 세션별 요약 생성
- 학습 진도 추적

**통신 방식**:
- **입력**: Pub/Sub (에이전트 → 에이전트)
- **출력**: Redis Streams (에이전트 → 백엔드)

## 🔄 메시지 플로우

### 1. 질문 분류 단계
```
사용자 → 프론트엔드 → 백엔드 → QuestionClassifierAgent
                                    ↓
                              분류 결과 + 라우팅 결정
```

### 2. 명료화 단계 (needs_clarify인 경우)
```
QuestionClassifierAgent → QuestionImprovementAgent
                                    ↓
                              명료화 질문 생성
                                    ↓
                              사용자 → 프론트엔드 → 백엔드
                                    ↓
                              명료화 답변 평가
                                    ↓
                              충분하면 → AnswerGeneratorAgent
```

### 3. 답변 생성 단계
```
AnswerGeneratorAgent → 답변 생성 (스트리밍)
                            ↓
                      백엔드 → 프론트엔드 → 사용자
                            ↓
                      ObserverAgent → 학습 요약 생성
```

## 🛠️ 기술 스택

### 에이전트
- **언어**: Python 3.11+
- **AI 모델**: OpenAI GPT-5-mini
- **메시지 큐**: Redis Streams + Pub/Sub
- **데이터베이스**: PostgreSQL (Async)
- **프롬프트 관리**: YAML 설정 파일

### 통신 프로토콜
- **Redis Streams**: 백엔드와 에이전트 간 메시지 전달
- **Redis Pub/Sub**: 에이전트 간 실시간 통신
- **JSON 메시지**: 구조화된 데이터 교환

## 📊 모니터링 및 로깅

### 주요 로그 포인트
- 에이전트 초기화 및 종료
- 메시지 큐 처리
- LLM 호출 및 응답
- 데이터베이스 작업

### 성능 모니터링
- Redis 메시지 큐 상태
- 데이터베이스 연결 풀
- LLM 응답 시간
- 메모리 사용량

## 🔒 보안 고려사항

### 프롬프트 보안
- 구분자와 해시를 통한 프롬프트 스푸핑 방지
- 역할 고정 및 시스템 지시사항 변경 시도 무시
- JSON 형식 응답만 허용

### 데이터 보호
- 사용자 입력 검증 및 정제
- 민감한 정보 환경변수 관리
- API 키 하드코딩 금지
