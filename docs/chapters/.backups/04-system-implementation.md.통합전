# IV. MAICE 시스템 구현

!!! abstract "4장 개요"
    본 장은 **3장의 교육적 설계를 실제 작동하는 시스템으로 구현한 기술적 측면**을 다룬다. 교육적 근거와 설계 원리는 3장을 참조하고, 여기서는 기술 스택, 코드 구조, 배포 전략에 집중한다. 재현 가능성(reproducibility)과 확장 가능성(scalability)을 확보하기 위한 구현 세부사항을 기술한다.

---


## 1. 시스템 구현 개요

본 장에서는 III장에서 제시한 MAICE 교육적 설계를 실제 시스템으로 구현한 내용 중 **교육적 로직에 해당하는 프롬프트 관리 시스템**을 기술한다. 기술 스택, 계층별 구현 상세, 배포 전략 등 기술적 세부사항은 **부록 A**에서 다룬다.

**시스템 개요**:
- **아키텍처**: 3계층 마이크로서비스 (프론트엔드 SvelteKit, 백엔드 FastAPI, 에이전트 Gemini 2.5 Flash)
- **핵심 기술**: Redis Streams (비동기 메시지 큐), PostgreSQL (데이터 저장)
- **교육적 핵심**: YAML 기반 프롬프트 관리 (K1-K4 답변 전략, 명료화 로직)

(기술 구현 상세는 부록 A 참조)

---

## 2. 프롬프트 관리 시스템

### 가. 프롬프트 관리 구조

모든 에이전트의 프롬프트는 **YAML 파일**로 관리되어 교사가 코드 수정 없이 교육적 전략을 조정할 수 있다. K1-K4 유형별 답변 전략과 명료화 질문 템플릿을 포함하며, 교육적 설계를 실제 시스템 동작으로 연결하는 핵심 구성 요소이다.

### 나. K1-K4별 답변 전략 구현

AG는 질문 유형에 따라 **완전히 다른 프롬프트 템플릿**을 사용한다:

**[그림Ⅳ-10] K1-K4별 프롬프트 템플릿 선택 로직**

```mermaid
graph LR
    A[질문 유형<br/>K1/K2/K3/K4] --> B{PromptBuilder}
    B -->|K1| C[사실적 지식<br/>템플릿]
    B -->|K2| D[개념적 지식<br/>템플릿]
    B -->|K3| E[절차적 지식<br/>템플릿]
    B -->|K4| F[메타인지적 지식<br/>템플릿]
    
    C --> G[답변 생성]
    D --> G
    E --> G
    F --> G
```

**템플릿 선택 로직** (`answer_generator/agent.py`):
```python
# 질문 유형에 따른 템플릿 선택
template_name = f"answer_{knowledge_code.lower()}"  # "answer_k1", "answer_k2" 등
prompt = await self.prompt_builder.build(template_name, {
    "question": final_question,
    "context": context,
    "clarification_history": clarification_history
})
```

**각 템플릿의 구조적 차이**:
- **K1**: 정의 → 예시 → 보충 (간결함 우선)
- **K2**: 개념 관계 → 비교 → 시각화 (연결성 강조)
- **K3**: 전체 개요 → 단계별 안내 → 실수 방지 (절차 명확성)
- **K4**: 문제 분석 → 다양한 접근 → 자기 점검 (메타인지 자극)

### 다. 명료화 평가 로직

QI Agent는 학생 응답을 평가하여 **PASS/NEED_MORE**를 판단한다:

**[그림Ⅳ-11] 명료화 평가 로직 (최대 3회 제한)**

```mermaid
flowchart LR
    A[학생 응답] --> B{평가}
    
    B -->|PASS| C[최종 질문 생성]
    C --> D[AG 실행]
    
    B -->|NEED_MORE| E{횟수 확인}
    E -->|"< 3회"| F[추가 명료화]
    E -->|"≥ 3회"| G[현재 정보로 진행]
    
    F --> A
    G --> D
    
    style B fill:#FFF3E0
    style E fill:#FFF3E0
```

**평가 기준**:
- **PASS**: 원본 질문의 의도가 명확해짐
- **NEED_MORE**: 여전히 모호하거나 추가 정보 필요
- **최대 3회 제한**: 무한 명료화 방지

### 라. 에이전트별 프롬프트 전문

본 시스템의 교육적 효과는 각 에이전트의 프롬프트 설계에 크게 의존한다. 이 절에서는 실제 운영 환경에서 사용된 핵심 프롬프트를 제시한다.

#### QC (Question Classifier) 프롬프트

**System 메시지**:
```
당신은 대한민국 고등학교 수학 교육과정 전문 분류기입니다.
질문을 정확히 분석하여 4가지 유형과 3단계 품질로 분류하고, 
필요한 경우 **학생에게 직접 묻는** 명료화 질문까지 생성하세요.

## 질문 유형 (K1-K4)
- K1 (즉답형): 정의, 용어, 기호, 공식, 값, 단위
- K2 (설명형): 개념 간 관계, 분류, 원리, 이론
- K3 (적용형): 수행 방법, 알고리즘, 단계별 과정
- K4 (문제해결형): 전략적 사고, 문제 접근법, 반성

## 품질 평가
- answerable: 교과·단원·수준 지정, 목표 동사 명확
- needs_clarify: 범위 과대/목표 불명/수준 불명
- unanswerable: 수학 외 영역, 평가윤리 위배

## 명료화 질문 생성 원칙 (Dewey 5단계)
1. 문제 인식: "어떤 부분이 가장 어렵거나 궁금하셨나요? 🤔"
2. 문제 정의: "지금까지 이해한 부분과 헷갈리는 부분을 나누어볼까요?"
3. 연결 탐색: "이미 알고 있는 개념과 비교하면 어떤 점이 다른가요?"
4. 사고 전개: "왜 이 부분이 궁금하신지 조금 더 설명해주실 수 있나요?"
5. 이해 검증: "어디까지 이해했고, 어디서부터 막히셨는지 말씀해주세요"

⚠️ 명료화 질문은 학생이 직접 읽고 답변할 수 있는 자연스러운 질문이어야 합니다!
❌ 시스템 분석: "'나'라는 답변이 구체적으로 무엇을 의미하는지 확인 필요"
✅ 학생 질문: "어떤 부분이 더 궁금하신가요? 😊"

## 출력 형식 (JSON)
{
  "knowledge_code": "K1/K2/K3/K4",
  "quality": "answerable/needs_clarify/unanswerable",
  "missing_fields": ["부족한 정보1", "부족한 정보2"],
  "reasoning": "분류 근거",
  "clarification_questions": ["학생에게 직접 묻는 자연스러운 질문 1개"],
  "clarification_reasoning": "명료화 질문이 어떻게 missing_fields를 해결하는지"
}
```

**설계 근거** (3장 3.3.1 참조):
- Dewey 반성적 사고 5단계를 명료화 질문 전략으로 구현
- Bloom K1-K4 분류로 질문 유형 차별화
- 학생 친화적 톤 ("🤔", 존댓말)으로 심리적 장벽 낮춤

### 라. 프롬프트 설계 핵심 요소

5개 에이전트의 프롬프트는 3장에서 제시한 교육적 설계 원칙을 다음과 같이 구현한다:

**QuestionClassifier (QC)**:
- Bloom K1-K4 분류 기준 명시
- answerable/needs_clarify/unanswerable 판정 로직
- 3장 표Ⅲ-3 분류 체계 직접 구현

**QuestionImprover (QI)**:
- Dewey 5단계 기반 명료화 질문 생성
- PASS/NEED_MORE 평가 기준 (최대 3회 제한)
- 학생 친화적 톤 ("🤔", 존댓말)

- **K1-K4별 차별화된 답변 구조** (3장 표Ⅲ-3 기반)
  - K1 (사실): 정의 → 공식 → 예시 (간결함 우선)
  - K2 (개념): 개념 관계 → 비교 → 시각화 (연결성 강조)
  - K3 (절차): 전체 개요 → 단계별 안내 → 실수 방지 (절차 명확성)
  - K4 (메타인지): 문제 분석 → 다양한 접근 → 자기 점검 (메타인지 촉진)
- LaTeX 수식 형식으로 수학적 정확성 확보
- 대한민국 교과서 표준 용어 사용 (예: "일반항" vs "명시적 공식")

**LearningObserver (LO)**:
- 학습 과정 요약 및 패턴 감지
- 반복 질문, 학습 진행 상태 추적
- 교사에게 학생 학습 상황 보고

**FreeTalker (FT)**:
- Freepass 모드 전용
- 즉시 답변 생성 (명료화 없이)
- 일반 LLM과 동일한 동작

(각 에이전트의 상세 프롬프트는 시스템 코드 저장소 참조)

---
- 모드는 전체 연구 기간 동안 고정
- 할당 비율: 50:50

**[그림Ⅳ-13] A/B 테스트 무작위 배정 구조**

```mermaid
flowchart LR
    A[신규 학생 가입] --> B{UserModeService<br/>무작위 배정}
    B -->|50%| C[Agent 모드<br/>명료화 O]
    B -->|50%| D[Freepass 모드<br/>명료화 X]
    
    C --> E[(PostgreSQL<br/>mode='agent')]
    D --> F[(PostgreSQL<br/>mode='freepass')]
```

**데이터 수집**:
- 모든 세션에 `mode` 필드 자동 기록
- 명료화 횟수, 질문 유형 등 메타데이터 저장
- 6장 분석에서 모드별 비교에 활용

---

